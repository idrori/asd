import{R as h}from"./index-DUqYuNXE.js";function A(n){return n?n.split(/\s+and\s+/i).map(e=>e.trim()).filter(e=>e.length>0):[]}function y(n,i){const e=[new RegExp(`${i}\\s*=\\s*\\{([^}]*)\\}`,"i"),new RegExp(`${i}\\s*=\\s*"([^"]*)"`,"i"),new RegExp(`${i}\\s*=\\s*(\\d+)`,"i")];for(const t of e){const s=n.match(t);if(s)return s[1].trim()}}function D(n){const i=n.match(/%\s*Relevance:\s*(.+?)(?:\n|$)/i);return i?i[1].trim():void 0}function k(n,i=""){const e=n.match(/@(\w+)\s*\{\s*([^,\s]+)\s*,/i);if(!e)return null;const t=e[1].toLowerCase(),s=e[2],a=y(n,"title")||"",o=y(n,"author")||"",c=y(n,"year"),r=y(n,"journal"),p=y(n,"booktitle"),g=y(n,"publisher"),m=y(n,"volume"),R=y(n,"number"),l=y(n,"pages"),u=y(n,"doi"),d=y(n,"url"),f=c?parseInt(c,10):void 0,C=A(o),L=D(i),V=a.replace(/\{([^}]*)\}/g,"$1").replace(/\\&/g,"&").replace(/\\/g,"").trim();return{type:t,key:s,title:V,authors:C,year:isNaN(f)?void 0:f,journal:r,booktitle:p,publisher:g,volume:m,number:R,pages:l,doi:u,url:d,relevanceComment:L,rawEntry:n.trim()}}function P(n){const i=[],e=[],t=/@(\w+)\s*\{/gi;let s;const a=[];for(;(s=t.exec(n))!==null;)a.push(s.index);for(let o=0;o<a.length;o++){const c=a[o];o<a.length-1?a[o+1]:n.length;let r=0,p=c,g=!1;for(let l=c;l<n.length;l++){const u=n[l];if(u==="{")r++,g=!0;else if(u==="}"&&(r--,g&&r===0)){p=l+1;break}}const m=n.substring(c,p),R=n.substring(Math.max(0,c-200),c);try{const l=k(m,R);l&&(l.title?i.push(l):e.push(`Entry "${l.key}" has no title`))}catch(l){e.push(`Failed to parse entry at position ${c}: ${l}`)}}return{entries:i,errors:e,rawContent:n}}function I(n,i){const e={...n,...i},t=[];t.push(`@${e.type}{${e.key},`),e.authors&&e.authors.length>0&&t.push(`  author = {${e.authors.join(" and ")}},`),t.push(`  title = {${e.title}},`),e.journal&&t.push(`  journal = {${e.journal}},`),e.booktitle&&t.push(`  booktitle = {${e.booktitle}},`),e.publisher&&t.push(`  publisher = {${e.publisher}},`),e.year&&t.push(`  year = {${e.year}},`),e.volume&&t.push(`  volume = {${e.volume}},`),e.number&&t.push(`  number = {${e.number}},`),e.pages&&t.push(`  pages = {${e.pages}},`),e.doi&&t.push(`  doi = {${e.doi}},`),e.url&&t.push(`  url = {${e.url}},`);const s=t[t.length-1];return t[t.length-1]=s.replace(/,$/,""),t.push("}"),t.join(`
`)}function w(n,i,e){const t=n.split(/[,\s]+/)[0].toLowerCase().replace(/[^a-z]/g,""),s=i?i.toString():"nd",a=e.toLowerCase().replace(/^(the|a|an)\s+/i,"").split(/\s+/)[0].replace(/[^a-z]/g,"");return`${t}${s}${a}`}function j(n,i){const e=n.length,t=i.length,s=Array(e+1).fill(null).map(()=>Array(t+1).fill(0));for(let a=0;a<=e;a++)s[a][0]=a;for(let a=0;a<=t;a++)s[0][a]=a;for(let a=1;a<=e;a++)for(let o=1;o<=t;o++)n[a-1]===i[o-1]?s[a][o]=s[a-1][o-1]:s[a][o]=1+Math.min(s[a-1][o],s[a][o-1],s[a-1][o-1]);return s[e][t]}function S(n){return n.toLowerCase().replace(/[^\w\s-]/g," ").replace(/\s+/g," ").replace(/\b(the|a|an|of|and|in|on|for|to|with)\b/g,"").replace(/\s+/g," ").trim()}function F(n,i){const e=S(n),t=S(i);if(e===t)return 1;if(e.length===0||t.length===0)return 0;const s=j(e,t),a=Math.max(e.length,t.length);return 1-s/a}function O(n,i){const e=S(n),t=S(i);if(e===t)return 1;const s=e.split(/[:\-–—]/)[0].trim(),a=t.split(/[:\-–—]/)[0].trim();if(s===a&&s.length>10)return .95;const o=F(n,i);return e.includes(t)||t.includes(e)?Math.max(o,.85):o}function M(n){const i=n.trim();if(i.includes(","))return i.split(",")[0].trim().toLowerCase();const e=i.split(/\s+/);return e.length>=2?e[e.length-1].toLowerCase():i.toLowerCase()}function N(n,i){if(n.length===0||i.length===0)return 0;const e=n.map(M),t=i.map(M),s=e[0]===t[0],a=e.filter(r=>t.includes(r)).length,o=Math.max(e.length,t.length),c=a/o;return s?.5+.5*c:c*.8}function _(n,i){if(n.doi&&i.doi){const t=n.doi.toLowerCase().replace(/^https?:\/\/doi\.org\//i,""),s=i.doi.toLowerCase().replace(/^https?:\/\/doi\.org\//i,"");if(t===s)return!0}const e=O(n.title,i.title);return!!(e>.95||e>.85&&n.year&&i.year&&n.year===i.year||e>.75&&n.authors&&i.authors&&n.year&&i.year&&N(n.authors,i.authors)>.5&&Math.abs(n.year-i.year)<=1)}var b={};const x=typeof window<"u"?"":b.VERCEL_URL?`https://${b.VERCEL_URL}`:"http://localhost:3000",$=`${x}/api/semantic-scholar`,E=2020,v=2025,Y=5,T=10,K=5;async function B(n){try{const i=await fetch($,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"validate",references:n})});return i.ok?await i.json():(console.error(`[RefValidation] SS validate failed: ${i.status}`),{success:!1,results:[]})}catch(i){return console.error("[RefValidation] SS validate error:",i),{success:!1,results:[]}}}async function U(n,i){try{const e=await fetch($,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"search",keywords:n,fieldsOfStudy:["Computer Science"],yearMin:(i==null?void 0:i.yearMin)||E,yearMax:(i==null?void 0:i.yearMax)||v,limit:(i==null?void 0:i.limit)||T})});return e.ok?await e.json():(console.error(`[RefValidation] SS search failed: ${e.status}`),{success:!1,papers:[]})}catch(e){return console.error("[RefValidation] SS search error:",e),{success:!1,papers:[]}}}async function X(n,i){try{const e=await fetch($,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"citations",paperId:n,type:i,limit:K})});return e.ok?await e.json():{success:!1,papers:[]}}catch(e){return console.error("[RefValidation] SS citations error:",e),{success:!1,papers:[]}}}async function J(n){console.log(`[RefValidation] Phase 2: Validating ${n.length} LLM references`);const i=n.map(t=>({bibKey:t.key,title:t.title,authors:t.authors,year:t.year})),e=await B(i);return e.success?e.results.map(t=>{const s=n.find(a=>a.key===t.bibKey);return{bibKey:t.bibKey,originalTitle:t.originalTitle,originalAuthors:s==null?void 0:s.authors,originalYear:s==null?void 0:s.year,status:t.status==="VERIFIED"?h.VERIFIED:t.status==="PARTIAL"?h.PARTIAL:h.UNVERIFIED,confidence:t.confidence,ssMatch:t.paper,discrepancies:t.discrepancies,source:"LLM"}}):n.map(t=>({bibKey:t.key,originalTitle:t.title,originalAuthors:t.authors,originalYear:t.year,status:h.UNVERIFIED,confidence:0,source:"LLM"}))}function z(n){const i=n.toLowerCase(),e=["information systems","digital transformation","artificial intelligence","machine learning","technology adoption","user acceptance","blockchain","social media","cybersecurity","data analytics","cloud computing","e-commerce","digital platform","IT governance","knowledge management","business intelligence","enterprise systems","human-computer interaction","technology acceptance model","TAM","UTAUT","IS success","digital innovation","IT investment","software development","agile","devops","healthcare IT","fintech","smart city","IoT","internet of things"],t=[];for(const a of e)i.includes(a.toLowerCase())&&t.push(a);const s=i.split(/\s+/).filter(a=>a.length>4);return[...new Set(s)],t.slice(0,Y)}async function G(n,i){var o,c,r,p,g,m,R;console.log("[RefValidation] Phase 3: Discovering additional papers");const e=[],t=new Set(i.map(l=>l.originalTitle.toLowerCase())),s=z(n);if(s.length>0){console.log(`[RefValidation] Searching with keywords: ${s.join(", ")}`);const l=await U(s,{yearMin:E,yearMax:v,limit:T});if(l.success)for(const u of l.papers)t.has(u.title.toLowerCase())||(u.citationCount||0)<5||(e.push({bibKey:w(((c=(o=u.authors)==null?void 0:o[0])==null?void 0:c.name)||"unknown",u.year,u.title),originalTitle:u.title,originalAuthors:(r=u.authors)==null?void 0:r.map(d=>d.name),originalYear:u.year,status:h.DISCOVERED,confidence:1,ssMatch:u,source:"SS_SEARCH"}),t.add(u.title.toLowerCase()))}const a=i.filter(l=>{var u;return l.status===h.VERIFIED&&((u=l.ssMatch)==null?void 0:u.paperId)});if(a.length>0)for(const l of a.slice(0,3)){if(!((p=l.ssMatch)!=null&&p.paperId))continue;const u=await X(l.ssMatch.paperId,"citations");if(u.success)for(const d of u.papers)t.has(d.title.toLowerCase())||(d.citationCount||0)<10||!d.year||d.year<E||(e.push({bibKey:w(((m=(g=d.authors)==null?void 0:g[0])==null?void 0:m.name)||"unknown",d.year,d.title),originalTitle:d.title,originalAuthors:(R=d.authors)==null?void 0:R.map(f=>f.name),originalYear:d.year,status:h.DISCOVERED,confidence:1,ssMatch:d,source:"SS_CITATION_GRAPH"}),t.add(d.title.toLowerCase()))}return console.log(`[RefValidation] Discovered ${e.length} additional papers`),e}function H(n,i,e){console.log("[RefValidation] Phase 4: Merging and deduplicating");const s=[...n].sort((o,c)=>{const r={[h.VERIFIED]:0,[h.PARTIAL]:1,[h.UNVERIFIED]:2,[h.REJECTED]:3,[h.DISCOVERED]:4};return r[o.status]-r[c.status]}).filter(o=>o.status!==h.REJECTED),a=new Set(s.map(o=>o.originalTitle.toLowerCase()));for(const o of i){if(s.length>=e.max)break;s.some(r=>_({title:r.originalTitle,authors:r.originalAuthors,year:r.originalYear},{title:o.originalTitle,authors:o.originalAuthors,year:o.originalYear}))||(s.push(o),a.add(o.originalTitle.toLowerCase()))}return console.log(`[RefValidation] Merged: ${s.length} references (${n.length} LLM + ${s.length-n.filter(o=>o.status!==h.REJECTED).length} discovered)`),s}function W(n,i,e){var s,a,o,c;console.log("[RefValidation] Phase 5: Generating final BibTeX");const t=[];t.push("% === REFERENCE VALIDATION REPORT ==="),t.push(`% Timestamp: ${e.timestamp}`),t.push(`% Total references: ${e.totalReferences}`),t.push(`% Verified: ${e.verified} (${(e.verified/e.totalReferences*100).toFixed(0)}%)`),t.push(`% Partial: ${e.partial} (${(e.partial/e.totalReferences*100).toFixed(0)}%)`),t.push(`% Unverified: ${e.unverified} (${(e.unverified/e.totalReferences*100).toFixed(0)}%)`),t.push(`% Discovered: ${e.discovered} (${(e.discovered/e.totalReferences*100).toFixed(0)}%)`),t.push(`% Recency (${E}-${v}): ${(e.recencyScore*100).toFixed(0)}%`),t.push(`% Verification rate: ${(e.verificationRate*100).toFixed(0)}%`),t.push("% ====================================="),t.push("");for(const r of n){t.push(`% Status: ${r.status} | Source: ${r.source}${r.confidence<1?` | Confidence: ${(r.confidence*100).toFixed(0)}%`:""}`),r.discrepancies&&r.discrepancies.length>0&&t.push(`% Discrepancies: ${r.discrepancies.join("; ")}`);const p=i.find(g=>g.key===r.bibKey);if(p&&(r.status===h.VERIFIED||r.status===h.PARTIAL)){const g={};r.ssMatch&&(r.ssMatch.doi&&(g.doi=r.ssMatch.doi),r.ssMatch.url&&(g.url=r.ssMatch.url)),t.push(I(p,g))}else if(r.ssMatch){const g={type:(s=r.ssMatch.venue)!=null&&s.includes("Conference")||(a=r.ssMatch.venue)!=null&&a.includes("Proceedings")?"inproceedings":"article",key:r.bibKey,title:r.ssMatch.title,authors:((o=r.ssMatch.authors)==null?void 0:o.map(m=>m.name))||[],year:r.ssMatch.year,journal:(c=r.ssMatch.journal)==null?void 0:c.name,booktitle:r.ssMatch.venue,doi:r.ssMatch.doi,url:r.ssMatch.url,rawEntry:""};t.push(I(g))}else p&&t.push(I(p));t.push("")}return t.join(`
`)}async function Q(n,i,e){e!=null&&e.targetMin;const t=(e==null?void 0:e.targetMax)||35;console.log("[RefValidation] Starting reference validation pipeline");const s=P(n);if(s.errors.length>0&&console.warn("[RefValidation] BibTeX parse errors:",s.errors),s.entries.length===0)return console.error("[RefValidation] No valid BibTeX entries found"),{bibtex:n,report:{timestamp:new Date().toISOString(),totalReferences:0,verified:0,partial:0,unverified:0,rejected:0,discovered:0,recencyScore:0,verificationRate:0,hallucinationRate:0,validatedReferences:[],discoveredReferences:[],errors:["No valid BibTeX entries found"]}};console.log(`[RefValidation] Parsed ${s.entries.length} BibTeX entries`);const a=await J(s.entries);let o=[];e!=null&&e.skipDiscovery||(o=await G(i,a));const c=H(a,o,{max:t}),r=c.filter(f=>f.status===h.VERIFIED).length,p=c.filter(f=>f.status===h.PARTIAL).length,g=c.filter(f=>f.status===h.UNVERIFIED).length,m=a.filter(f=>f.status===h.REJECTED).length,R=c.filter(f=>f.status===h.DISCOVERED).length,l=c.filter(f=>f.originalYear&&f.originalYear>=E&&f.originalYear<=v).length,u={timestamp:new Date().toISOString(),totalReferences:c.length,verified:r,partial:p,unverified:g,rejected:m,discovered:R,recencyScore:c.length>0?l/c.length:0,verificationRate:c.length>0?(r+p)/c.length:0,hallucinationRate:a.length>0?m/a.length:0,validatedReferences:a,discoveredReferences:o,errors:s.errors},d=W(c,s.entries,u);return console.log(`[RefValidation] Complete: ${c.length} refs, ${(u.verificationRate*100).toFixed(0)}% verified, ${(u.recencyScore*100).toFixed(0)}% recent`),{bibtex:d,report:u}}export{Q as validateAndEnrichReferences};
