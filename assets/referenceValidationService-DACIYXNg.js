import{R as d}from"./index-rIw_ot2Z.js";function k(s){return s?s.split(/\s+and\s+/i).map(e=>e.trim()).filter(e=>e.length>0):[]}function y(s,t){const e=[new RegExp(`${t}\\s*=\\s*\\{([^}]*)\\}`,"i"),new RegExp(`${t}\\s*=\\s*"([^"]*)"`,"i"),new RegExp(`${t}\\s*=\\s*(\\d+)`,"i")];for(const n of e){const i=s.match(n);if(i)return i[1].trim()}}function j(s){const t=s.match(/%\s*Relevance:\s*(.+?)(?:\n|$)/i);return t?t[1].trim():void 0}function P(s,t=""){const e=s.match(/@(\w+)\s*\{\s*([^,\s]+)\s*,/i);if(!e)return null;const n=e[1].toLowerCase(),i=e[2],a=y(s,"title")||"",r=y(s,"author")||"",c=y(s,"year"),o=y(s,"journal"),l=y(s,"booktitle"),u=y(s,"publisher"),p=y(s,"volume"),E=y(s,"number"),h=y(s,"pages"),f=y(s,"doi"),g=y(s,"url"),m=c?parseInt(c,10):void 0,A=k(r),T=j(t),D=a.replace(/\{([^}]*)\}/g,"$1").replace(/\\&/g,"&").replace(/\\/g,"").trim();return{type:n,key:i,title:D,authors:A,year:isNaN(m)?void 0:m,journal:o,booktitle:l,publisher:u,volume:p,number:E,pages:h,doi:f,url:g,relevanceComment:T,rawEntry:s.trim()}}function F(s){const t=[],e=[],n=/@(\w+)\s*\{/gi;let i;const a=[];for(;(i=n.exec(s))!==null;)a.push(i.index);for(let r=0;r<a.length;r++){const c=a[r];r<a.length-1?a[r+1]:s.length;let o=0,l=c,u=!1;for(let h=c;h<s.length;h++){const f=s[h];if(f==="{")o++,u=!0;else if(f==="}"&&(o--,u&&o===0)){l=h+1;break}}const p=s.substring(c,l),E=s.substring(Math.max(0,c-200),c);try{const h=P(p,E);h&&(h.title?t.push(h):e.push(`Entry "${h.key}" has no title`))}catch(h){e.push(`Failed to parse entry at position ${c}: ${h}`)}}return{entries:t,errors:e,rawContent:s}}function I(s,t){const e={...s,...t},n=[];n.push(`@${e.type}{${e.key},`),e.authors&&e.authors.length>0&&n.push(`  author = {${e.authors.join(" and ")}},`),n.push(`  title = {${e.title}},`),e.journal&&n.push(`  journal = {${e.journal}},`),e.booktitle&&n.push(`  booktitle = {${e.booktitle}},`),e.publisher&&n.push(`  publisher = {${e.publisher}},`),e.year&&n.push(`  year = {${e.year}},`),e.volume&&n.push(`  volume = {${e.volume}},`),e.number&&n.push(`  number = {${e.number}},`),e.pages&&n.push(`  pages = {${e.pages}},`),e.doi&&n.push(`  doi = {${e.doi}},`),e.url&&n.push(`  url = {${e.url}},`);const i=n[n.length-1];return n[n.length-1]=i.replace(/,$/,""),n.push("}"),n.join(`
`)}function v(s,t,e){const n=s.split(/[,\s]+/)[0].toLowerCase().replace(/[^a-z]/g,""),i=t?t.toString():"nd",a=e.toLowerCase().replace(/^(the|a|an)\s+/i,"").split(/\s+/)[0].replace(/[^a-z]/g,"");return`${n}${i}${a}`}function N(s,t){const e=s.length,n=t.length,i=Array(e+1).fill(null).map(()=>Array(n+1).fill(0));for(let a=0;a<=e;a++)i[a][0]=a;for(let a=0;a<=n;a++)i[0][a]=a;for(let a=1;a<=e;a++)for(let r=1;r<=n;r++)s[a-1]===t[r-1]?i[a][r]=i[a-1][r-1]:i[a][r]=1+Math.min(i[a-1][r],i[a][r-1],i[a-1][r-1]);return i[e][n]}function $(s){return s.toLowerCase().replace(/[^\w\s-]/g," ").replace(/\s+/g," ").replace(/\b(the|a|an|of|and|in|on|for|to|with)\b/g,"").replace(/\s+/g," ").trim()}function x(s,t){const e=$(s),n=$(t);if(e===n)return 1;if(e.length===0||n.length===0)return 0;const i=N(e,n),a=Math.max(e.length,n.length);return 1-i/a}function O(s,t){const e=$(s),n=$(t);if(e===n)return 1;const i=e.split(/[:\-–—]/)[0].trim(),a=n.split(/[:\-–—]/)[0].trim();if(i===a&&i.length>10)return .95;const r=x(s,t);return e.includes(n)||n.includes(e)?Math.max(r,.85):r}function b(s){const t=s.trim();if(t.includes(","))return t.split(",")[0].trim().toLowerCase();const e=t.split(/\s+/);return e.length>=2?e[e.length-1].toLowerCase():t.toLowerCase()}function _(s,t){if(s.length===0||t.length===0)return 0;const e=s.map(b),n=t.map(b),i=e[0]===n[0],a=e.filter(o=>n.includes(o)).length,r=Math.max(e.length,n.length),c=a/r;return i?.5+.5*c:c*.8}function U(s,t){if(s.doi&&t.doi){const n=s.doi.toLowerCase().replace(/^https?:\/\/doi\.org\//i,""),i=t.doi.toLowerCase().replace(/^https?:\/\/doi\.org\//i,"");if(n===i)return!0}const e=O(s.title,t.title);return!!(e>.95||e>.85&&s.year&&t.year&&s.year===t.year||e>.75&&s.authors&&t.authors&&s.year&&t.year&&_(s.authors,t.authors)>.5&&Math.abs(s.year-t.year)<=1)}var C={};const Y=typeof window<"u"?"":C.VERCEL_URL?`https://${C.VERCEL_URL}`:"http://localhost:3000",w=`${Y}/api/semantic-scholar`,B=.85,X=.65,R=2020,S=2025,z=5,M=10,W=5;async function J(s){try{const t=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"validate",references:s})});return t.ok?await t.json():(console.error(`[RefValidation] SS validate failed: ${t.status}`),{success:!1,results:[]})}catch(t){return console.error("[RefValidation] SS validate error:",t),{success:!1,results:[]}}}async function V(s,t){try{const e=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"search",keywords:s,fieldsOfStudy:["Computer Science"],yearMin:(t==null?void 0:t.yearMin)||R,yearMax:(t==null?void 0:t.yearMax)||S,limit:(t==null?void 0:t.limit)||M})});return e.ok?await e.json():(console.error(`[RefValidation] SS search failed: ${e.status}`),{success:!1,papers:[]})}catch(e){return console.error("[RefValidation] SS search error:",e),{success:!1,papers:[]}}}async function Z(s,t){try{const e=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"citations",paperId:s,type:t,limit:W})});return e.ok?await e.json():{success:!1,papers:[]}}catch(e){return console.error("[RefValidation] SS citations error:",e),{success:!1,papers:[]}}}async function G(s){console.log(`[RefValidation] Phase 2: Validating ${s.length} LLM references`);const t=s.map(n=>({bibKey:n.key,title:n.title,authors:n.authors,year:n.year})),e=await J(t);return e.success?e.results.map(n=>{const i=s.find(a=>a.key===n.bibKey);return{bibKey:n.bibKey,originalTitle:n.originalTitle,originalAuthors:i==null?void 0:i.authors,originalYear:i==null?void 0:i.year,status:n.status==="VERIFIED"?d.VERIFIED:n.status==="PARTIAL"?d.PARTIAL:d.UNVERIFIED,confidence:n.confidence,ssMatch:n.paper,discrepancies:n.discrepancies,source:"LLM"}}):s.map(n=>({bibKey:n.key,originalTitle:n.title,originalAuthors:n.authors,originalYear:n.year,status:d.UNVERIFIED,confidence:0,source:"LLM"}))}function H(s){const t=s.toLowerCase(),e=["information systems","digital transformation","artificial intelligence","machine learning","technology adoption","user acceptance","blockchain","social media","cybersecurity","data analytics","cloud computing","e-commerce","digital platform","IT governance","knowledge management","business intelligence","enterprise systems","human-computer interaction","technology acceptance model","TAM","UTAUT","IS success","digital innovation","IT investment","software development","agile","devops","healthcare IT","fintech","smart city","IoT","internet of things"],n=[];for(const a of e)t.includes(a.toLowerCase())&&n.push(a);const i=t.split(/\s+/).filter(a=>a.length>4);return[...new Set(i)],n.slice(0,z)}async function q(s,t){var r,c,o,l,u,p,E;console.log("[RefValidation] Phase 3: Discovering additional papers");const e=[],n=new Set(t.map(h=>h.originalTitle.toLowerCase())),i=H(s);if(i.length>0){console.log(`[RefValidation] Searching with keywords: ${i.join(", ")}`);const h=await V(i,{yearMin:R,yearMax:S,limit:M});if(h.success)for(const f of h.papers)n.has(f.title.toLowerCase())||(f.citationCount||0)<5||(e.push({bibKey:v(((c=(r=f.authors)==null?void 0:r[0])==null?void 0:c.name)||"unknown",f.year,f.title),originalTitle:f.title,originalAuthors:(o=f.authors)==null?void 0:o.map(g=>g.name),originalYear:f.year,status:d.DISCOVERED,confidence:1,ssMatch:f,source:"SS_SEARCH"}),n.add(f.title.toLowerCase()))}const a=t.filter(h=>{var f;return h.status===d.VERIFIED&&((f=h.ssMatch)==null?void 0:f.paperId)});if(a.length>0)for(const h of a.slice(0,3)){if(!((l=h.ssMatch)!=null&&l.paperId))continue;const f=await Z(h.ssMatch.paperId,"citations");if(f.success)for(const g of f.papers)n.has(g.title.toLowerCase())||(g.citationCount||0)<10||!g.year||g.year<R||(e.push({bibKey:v(((p=(u=g.authors)==null?void 0:u[0])==null?void 0:p.name)||"unknown",g.year,g.title),originalTitle:g.title,originalAuthors:(E=g.authors)==null?void 0:E.map(m=>m.name),originalYear:g.year,status:d.DISCOVERED,confidence:1,ssMatch:g,source:"SS_CITATION_GRAPH"}),n.add(g.title.toLowerCase()))}return console.log(`[RefValidation] Discovered ${e.length} additional papers`),e}function Q(s,t,e){console.log("[RefValidation] Phase 4: Merging and deduplicating");const i=[...s].sort((r,c)=>{const o={[d.VERIFIED]:0,[d.PARTIAL]:1,[d.UNVERIFIED]:2,[d.REJECTED]:3,[d.DISCOVERED]:4};return o[r.status]-o[c.status]}).filter(r=>r.status!==d.REJECTED),a=new Set(i.map(r=>r.originalTitle.toLowerCase()));for(const r of t){if(i.length>=e.max)break;i.some(o=>U({title:o.originalTitle,authors:o.originalAuthors,year:o.originalYear},{title:r.originalTitle,authors:r.originalAuthors,year:r.originalYear}))||(i.push(r),a.add(r.originalTitle.toLowerCase()))}return console.log(`[RefValidation] Merged: ${i.length} references (${s.length} LLM + ${i.length-s.filter(r=>r.status!==d.REJECTED).length} discovered)`),i}function K(s,t,e){var i,a,r,c;console.log("[RefValidation] Phase 5: Generating final BibTeX");const n=[];n.push("% === REFERENCE VALIDATION REPORT ==="),n.push(`% Timestamp: ${e.timestamp}`),n.push(`% Total references: ${e.totalReferences}`),n.push(`% Verified: ${e.verified} (${(e.verified/e.totalReferences*100).toFixed(0)}%)`),n.push(`% Partial: ${e.partial} (${(e.partial/e.totalReferences*100).toFixed(0)}%)`),n.push(`% Unverified: ${e.unverified} (${(e.unverified/e.totalReferences*100).toFixed(0)}%)`),n.push(`% Discovered: ${e.discovered} (${(e.discovered/e.totalReferences*100).toFixed(0)}%)`),n.push(`% Recency (${R}-${S}): ${(e.recencyScore*100).toFixed(0)}%`),n.push(`% Verification rate: ${(e.verificationRate*100).toFixed(0)}%`),n.push("% ====================================="),n.push("");for(const o of s){if(o.status===d.UNVERIFIED)continue;n.push(`% Status: ${o.status} | Source: ${o.source}${o.confidence<1?` | Confidence: ${(o.confidence*100).toFixed(0)}%`:""}`),o.discrepancies&&o.discrepancies.length>0&&n.push(`% Discrepancies: ${o.discrepancies.join("; ")}`);const l=t.find(u=>u.key===o.bibKey);if(l&&(o.status===d.VERIFIED||o.status===d.PARTIAL)){const u={};o.ssMatch&&(o.ssMatch.doi&&(u.doi=o.ssMatch.doi),o.ssMatch.url&&(u.url=o.ssMatch.url)),n.push(I(l,u))}else if(o.ssMatch){const u={type:(i=o.ssMatch.venue)!=null&&i.includes("Conference")||(a=o.ssMatch.venue)!=null&&a.includes("Proceedings")?"inproceedings":"article",key:o.bibKey,title:o.ssMatch.title,authors:((r=o.ssMatch.authors)==null?void 0:r.map(p=>p.name))||[],year:o.ssMatch.year,journal:(c=o.ssMatch.journal)==null?void 0:c.name,booktitle:o.ssMatch.venue,doi:o.ssMatch.doi,url:o.ssMatch.url,rawEntry:""};n.push(I(u))}else l&&n.push(I(l));n.push("")}return n.join(`
`)}async function re(s,t,e){e!=null&&e.targetMin;const n=(e==null?void 0:e.targetMax)||35;console.log("[RefValidation] Starting reference validation pipeline");const i=F(s);if(i.errors.length>0&&console.warn("[RefValidation] BibTeX parse errors:",i.errors),i.entries.length===0)return console.error("[RefValidation] No valid BibTeX entries found"),{bibtex:s,report:{timestamp:new Date().toISOString(),totalReferences:0,verified:0,partial:0,unverified:0,rejected:0,discovered:0,recencyScore:0,verificationRate:0,hallucinationRate:0,validatedReferences:[],discoveredReferences:[],errors:["No valid BibTeX entries found"]}};console.log(`[RefValidation] Parsed ${i.entries.length} BibTeX entries`);const a=await G(i.entries);let r=[];e!=null&&e.skipDiscovery||(r=await q(t,a));const c=Q(a,r,{max:n}),o=c.filter(m=>m.status===d.VERIFIED).length,l=c.filter(m=>m.status===d.PARTIAL).length,u=c.filter(m=>m.status===d.UNVERIFIED).length,p=a.filter(m=>m.status===d.REJECTED).length,E=c.filter(m=>m.status===d.DISCOVERED).length,h=c.filter(m=>m.originalYear&&m.originalYear>=R&&m.originalYear<=S).length,f={timestamp:new Date().toISOString(),totalReferences:c.length,verified:o,partial:l,unverified:u,rejected:p,discovered:E,recencyScore:c.length>0?h/c.length:0,verificationRate:c.length>0?(o+l)/c.length:0,hallucinationRate:a.length>0?p/a.length:0,validatedReferences:a,discoveredReferences:r,errors:i.errors},g=K(c,i.entries,f);return console.log(`[RefValidation] Complete: ${c.length} refs, ${(f.verificationRate*100).toFixed(0)}% verified, ${(f.recencyScore*100).toFixed(0)}% recent`),{bibtex:g,report:f}}function ee(s){const t=s.match(/^([a-z]+)(\d{4})(.*)$/i);if(t)return{author:t[1],year:parseInt(t[2],10),keyword:t[3]||""};const e=s.match(/(\d{4})/),n=e?parseInt(e[1],10):null;return{author:s.replace(/\d+/g,"").replace(/[^a-zA-Z]/g,""),year:n,keyword:""}}function te(s){const t=[];if(s.author&&t.push(s.author),s.keyword){const e=s.keyword.replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase();t.push(e)}return t.join(" ")}async function ne(s,t){if(t.has(s))return{citationKey:s,status:"ALREADY_EXISTS",confidence:1,bibtexEntry:""};console.log(`[IncrementalValidation] Validating citation: ${s}`);const e=ee(s),n=te(e);console.log(`[IncrementalValidation] Parsed: author="${e.author}", year=${e.year}, keyword="${e.keyword}"`),console.log(`[IncrementalValidation] Search query: "${n}"`);const i=await V([n],{yearMin:e.year?e.year-1:1980,yearMax:e.year?e.year+1:2025,limit:5});if(!i.success||i.papers.length===0){console.log(`[IncrementalValidation] No results for "${s}" - generating unverified entry`);const u=L(s,e);return{citationKey:s,status:"UNVERIFIED",confidence:0,bibtexEntry:u,searchQuery:n}}const a=se(i.papers,e);if(!a){console.log(`[IncrementalValidation] No good match for "${s}"`);const u=L(s,e);return{citationKey:s,status:"UNVERIFIED",confidence:.3,bibtexEntry:u,searchQuery:n}}const{paper:r,confidence:c}=a,o=ie(s,r),l=c>=B?"VERIFIED":c>=X?"PARTIAL":"UNVERIFIED";return console.log(`[IncrementalValidation] Found match: "${r.title}" (confidence: ${(c*100).toFixed(0)}%, status: ${l})`),{citationKey:s,status:l,confidence:c,bibtexEntry:o,paper:r,searchQuery:n}}function se(s,t){let e=null,n=0;for(const i of s){let a=0;if(t.year&&i.year&&(i.year===t.year?a+=.3:Math.abs(i.year-t.year)===1&&(a+=.2)),t.author&&i.authors&&i.authors.length>0){const r=t.author.toLowerCase();i.authors.some(o=>{var l;return o.name.toLowerCase().includes(r)||r.includes(((l=o.name.split(" ").pop())==null?void 0:l.toLowerCase())||"")})&&(a+=.4)}if(t.keyword&&i.title){const r=t.keyword.toLowerCase(),c=i.title.toLowerCase(),o=r.replace(/([a-z])([A-Z])/g,"$1 $2").split(" "),l=o.filter(u=>u.length>3&&c.includes(u));l.length>0&&(a+=.3*(l.length/o.length))}a>n&&(n=a,e=i)}return e&&n>=.4?{paper:e,confidence:Math.min(n,1)}:null}function ie(s,t){var a,r,c,o;const e=((a=t.venue)==null?void 0:a.includes("Conference"))||((r=t.venue)==null?void 0:r.includes("Proceedings"))||((c=t.venue)==null?void 0:c.includes("Workshop")),n=e?"inproceedings":"article",i=[];if(i.push(`@${n}{${s},`),t.authors&&t.authors.length>0){const l=t.authors.map(u=>u.name).join(" and ");i.push(`  author = {${l}},`)}return i.push(`  title = {${t.title}},`),t.year&&i.push(`  year = {${t.year}},`),e&&t.venue?i.push(`  booktitle = {${t.venue}},`):(o=t.journal)!=null&&o.name?(i.push(`  journal = {${t.journal.name}},`),t.journal.volume&&i.push(`  volume = {${t.journal.volume}},`),t.journal.pages&&i.push(`  pages = {${t.journal.pages}},`)):t.venue&&i.push(`  journal = {${t.venue}},`),t.doi&&i.push(`  doi = {${t.doi}},`),t.url&&i.push(`  url = {${t.url}},`),i.push("  note = {Validated via Semantic Scholar}"),i.push("}"),i.join(`
`)}function L(s,t){const e=[];e.push("% Status: UNVERIFIED | Source: LLM | Confidence: 0%"),e.push(`@article{${s},`);const n=t.author.charAt(0).toUpperCase()+t.author.slice(1);e.push(`  author = {${n}},`);const a=t.keyword.replace(/([a-z])([A-Z])/g,"$1 $2").split(" ").map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" ")||`Research on ${n}'s Work`;return e.push(`  title = {${a}},`),t.year?e.push(`  year = {${t.year}},`):e.push("  year = {n.d.},"),e.push("  journal = {Working Paper},"),e.push("  note = {Citation requires verification}"),e.push("}"),e.join(`
`)}async function oe(s,t){const e=[],n=s.filter(a=>!t.has(a));console.log(`[IncrementalValidation] Batch validating ${n.length} new citations (${s.length-n.length} already exist)`);const i=3;for(let a=0;a<n.length;a+=i){const r=n.slice(a,a+i),c=await Promise.all(r.map(o=>ne(o,t)));e.push(...c),a+i<n.length&&await new Promise(o=>setTimeout(o,200))}for(const a of s)t.has(a)&&e.push({citationKey:a,status:"ALREADY_EXISTS",confidence:1,bibtexEntry:""});return e}function ce(s){const t=/\\cite\{([^}]+)\}/g,e=new Set;let n;for(;(n=t.exec(s))!==null;)n[1].split(",").map(a=>a.trim()).forEach(a=>e.add(a));return[...e]}export{ce as extractCitationKeys,re as validateAndEnrichReferences,oe as validateCitationBatch,ne as validateSingleCitation};
