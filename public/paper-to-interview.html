<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper to Open Research Interview</title>
  <style>
    /* Reset & Base */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; line-height: 1.5; }

    /* Layout */
    .min-h-screen { min-height: 100vh; }
    .max-w-4xl { max-width: 56rem; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .p-6 { padding: 1.5rem; }
    .p-4 { padding: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .max-h-96 { max-height: 24rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .overflow-y-auto { overflow-y: auto; }

    /* Flexbox */
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .gap-2 { gap: 0.5rem; }
    .text-center { text-align: center; }

    /* Typography */
    .text-2xl { font-size: 1.5rem; }
    .text-lg { font-size: 1.125rem; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }
    .font-mono { font-family: ui-monospace, monospace; }
    .whitespace-pre-wrap { white-space: pre-wrap; }

    /* Colors */
    .bg-slate-100 { background-color: #f1f5f9; }
    .bg-white { background-color: #fff; }
    .bg-slate-50 { background-color: #f8fafc; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-emerald-600 { background-color: #059669; }
    .bg-slate-200 { background-color: #e2e8f0; }
    .bg-slate-300 { background-color: #cbd5e1; }
    .bg-red-50 { background-color: #fef2f2; }
    .bg-red-600 { background-color: #dc2626; }
    .text-slate-800 { color: #1e293b; }
    .text-slate-700 { color: #334155; }
    .text-slate-600 { color: #475569; }
    .text-slate-500 { color: #64748b; }
    .text-slate-400 { color: #94a3b8; }
    .text-white { color: #fff; }
    .text-emerald-600 { color: #059669; }
    .text-red-600 { color: #dc2626; }
    .text-red-700 { color: #b91c1c; }

    /* Borders */
    .border { border-width: 1px; border-style: solid; }
    .border-2 { border-width: 2px; border-style: solid; }
    .border-slate-200 { border-color: #e2e8f0; }
    .border-slate-300 { border-color: #cbd5e1; }
    .border-red-200 { border-color: #fecaca; }
    .border-dashed { border-style: dashed; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }

    /* Interactive */
    .cursor-pointer { cursor: pointer; }
    .transition-colors { transition: background-color 0.15s, border-color 0.15s, color 0.15s; }
    .hidden { display: none; }

    /* Buttons */
    button { border: none; cursor: pointer; }
    button:disabled { background-color: #cbd5e1; cursor: not-allowed; }
    button.bg-blue-600:hover:not(:disabled) { background-color: #1d4ed8; }
    button.bg-emerald-600:hover { background-color: #047857; }
    button.bg-slate-200:hover { background-color: #cbd5e1; }
    button.bg-red-600:hover { background-color: #b91c1c; }

    /* Upload zones */
    .border-dashed:hover { border-color: #60a5fa; }

    /* Icons */
    .w-12 { width: 3rem; }
    .h-12 { height: 3rem; }
    .w-5 { width: 1.25rem; }
    .h-5 { height: 1.25rem; }

    /* Spinner */
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
      <h1 class="text-2xl font-bold text-slate-800 mb-2">Paper to Open Research Interview</h1>
      <p class="text-slate-600">
        Upload a research paper (PDF) and an interview format template. The AI will analyze the paper
        and generate a synthetic research interview about an open research problem stemming from the
        paper's limitations, future work, or unexplored directions.
      </p>
    </div>

    <!-- Upload Section -->
    <div id="upload-section" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">1. Upload Files</h2>

      <!-- Paper PDF Upload -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">Research Paper (PDF)</label>
        <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
          <input type="file" id="paper-file" accept=".pdf" class="hidden" onchange="handlePaperUpload(event)">
          <label for="paper-file" class="cursor-pointer">
            <div id="paper-preview" class="text-slate-500">
              <svg class="w-12 h-12 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
              </svg>
              <p>Click to upload PDF paper</p>
              <p class="text-xs text-slate-400 mt-1">Max 3MB</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Interview Format Upload -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">Interview Format Template (TXT)</label>
        <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
          <input type="file" id="format-file" accept=".txt" class="hidden" onchange="handleFormatUpload(event)">
          <label for="format-file" class="cursor-pointer">
            <div id="format-preview" class="text-slate-500">
              <svg class="w-12 h-12 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p>Click to upload interview format template</p>
              <p class="text-xs text-slate-400 mt-1">Text file with interview structure</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Generate Button -->
      <button
        id="generate-btn"
        onclick="generateInterview()"
        disabled
        class="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors"
      >
        Generate Open Research Interview
      </button>
    </div>

    <!-- Processing Section -->
    <div id="processing-section" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-slate-800 mb-2">Analyzing Paper...</h3>
        <p id="processing-status" class="text-slate-600">Reading and understanding the paper content</p>
      </div>
    </div>

    <!-- Result Section -->
    <div id="result-section" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Generated Interview</h2>

      <!-- Preview -->
      <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-4 max-h-96 overflow-y-auto">
        <pre id="interview-preview" class="whitespace-pre-wrap text-sm text-slate-700 font-mono"></pre>
      </div>

      <!-- Download Button -->
      <button
        id="download-btn"
        onclick="downloadInterview()"
        class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        Download Interview File
      </button>

      <!-- Generate Another -->
      <button
        onclick="resetForm()"
        class="mt-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-6 rounded-lg transition-colors"
      >
        Generate Another
      </button>
    </div>

    <!-- Error Section -->
    <div id="error-section" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 mb-6">
      <h3 class="text-red-700 font-semibold mb-2">Error</h3>
      <p id="error-message" class="text-red-600"></p>
      <button
        onclick="resetForm()"
        class="mt-4 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
      >
        Try Again
      </button>
    </div>
  </div>

  <script>
    // State
    let paperFile = null;
    let formatFile = null;
    let generatedInterview = '';

    // Max file size (3MB to account for base64 overhead staying under 4.5MB limit)
    const MAX_FILE_SIZE_MB = 3;

    // Handle paper upload
    function handlePaperUpload(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/pdf') {
        const fileSizeMB = file.size / 1024 / 1024;

        if (fileSizeMB > MAX_FILE_SIZE_MB) {
          document.getElementById('paper-preview').innerHTML = `
            <div class="text-red-600">
              <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <p class="font-medium">File too large</p>
              <p class="text-xs mt-1">${fileSizeMB.toFixed(2)} MB exceeds ${MAX_FILE_SIZE_MB}MB limit</p>
              <p class="text-xs text-slate-500 mt-1">Please use a smaller PDF</p>
            </div>
          `;
          paperFile = null;
          checkCanGenerate();
          return;
        }

        paperFile = file;
        document.getElementById('paper-preview').innerHTML = `
          <div class="text-emerald-600">
            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="font-medium">${file.name}</p>
            <p class="text-xs text-slate-500 mt-1">${fileSizeMB.toFixed(2)} MB</p>
          </div>
        `;
        checkCanGenerate();
      }
    }

    // Handle format upload
    function handleFormatUpload(event) {
      const file = event.target.files[0];
      if (file) {
        formatFile = file;
        document.getElementById('format-preview').innerHTML = `
          <div class="text-emerald-600">
            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="font-medium">${file.name}</p>
            <p class="text-xs text-slate-500 mt-1">${(file.size / 1024).toFixed(1)} KB</p>
          </div>
        `;
        checkCanGenerate();
      }
    }

    // Check if both files are uploaded
    function checkCanGenerate() {
      const btn = document.getElementById('generate-btn');
      btn.disabled = !(paperFile && formatFile);
    }

    // Convert file to base64
    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Read text file
    async function readTextFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    // Generate interview
    async function generateInterview() {
      if (!paperFile || !formatFile) return;

      // Show processing
      document.getElementById('upload-section').classList.add('hidden');
      document.getElementById('processing-section').classList.remove('hidden');
      document.getElementById('result-section').classList.add('hidden');
      document.getElementById('error-section').classList.add('hidden');

      try {
        // Read files
        updateStatus('Reading paper and format files...');
        const pdfBase64 = await fileToBase64(paperFile);
        const formatText = await readTextFile(formatFile);

        // Call API - use absolute URL to ensure it works from both Vercel and GitHub Pages
        updateStatus('Analyzing paper with Gemini AI...');
        const apiBase = window.location.hostname.includes('github.io')
          ? 'https://icis-deploy-12-10-2025.vercel.app'
          : '';
        const response = await fetch(`${apiBase}/api/paper-to-interview`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pdfBase64,
            formatTemplate: formatText,
            paperName: paperFile.name
          })
        });

        if (!response.ok) {
          let errorMessage = 'Failed to generate interview';
          try {
            const error = await response.json();
            errorMessage = error.details || error.error || errorMessage;
          } catch {
            errorMessage = `Server error (${response.status}): API may not be available`;
          }
          throw new Error(errorMessage);
        }

        const result = await response.json();
        generatedInterview = result.interview;

        // Show result
        document.getElementById('processing-section').classList.add('hidden');
        document.getElementById('result-section').classList.remove('hidden');
        document.getElementById('interview-preview').textContent = generatedInterview;

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('processing-section').classList.add('hidden');
        document.getElementById('error-section').classList.remove('hidden');
        document.getElementById('error-message').textContent = error.message;
      }
    }

    // Update processing status
    function updateStatus(text) {
      document.getElementById('processing-status').textContent = text;
    }

    // Download interview
    function downloadInterview() {
      if (!generatedInterview) return;

      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
      const filename = `open_research_interview_${timestamp}.txt`;

      const blob = new Blob([generatedInterview], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Reset form
    function resetForm() {
      paperFile = null;
      formatFile = null;
      generatedInterview = '';

      document.getElementById('paper-file').value = '';
      document.getElementById('format-file').value = '';

      document.getElementById('paper-preview').innerHTML = `
        <svg class="w-12 h-12 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
        </svg>
        <p>Click to upload PDF paper</p>
        <p class="text-xs text-slate-400 mt-1">Max 3MB</p>
      `;

      document.getElementById('format-preview').innerHTML = `
        <svg class="w-12 h-12 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p>Click to upload interview format template</p>
        <p class="text-xs text-slate-400 mt-1">Text file with interview structure</p>
      `;

      document.getElementById('generate-btn').disabled = true;
      document.getElementById('upload-section').classList.remove('hidden');
      document.getElementById('processing-section').classList.add('hidden');
      document.getElementById('result-section').classList.add('hidden');
      document.getElementById('error-section').classList.add('hidden');
    }
  </script>
</body>
</html>
